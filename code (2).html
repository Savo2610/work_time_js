<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arbeitszeit Rechner</title>
    <style>
        /* CSS bleibt unverändert - hier zur Kürze weggelassen, bitte den vorherigen Code verwenden */
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 450px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }
        input[type="time"],
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* Include padding in width */
            font-size: 1rem;
        }
         input[type="number"] {
            /* Make number input slightly less wide to accomodate potential units text */
             width: calc(100% - 70px); /* Adjust as needed */
             display: inline-block; /* Allow text next to it */
         }
        .unit {
             display: inline-block;
             margin-left: 10px;
             color: #555;
         }

        .output-group {
            margin-top: 25px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .output-group p {
            margin: 12px 0;
            font-size: 1.1rem;
            color: #333;
            display: flex;
            justify-content: space-between; /* Align label and value */
        }
        .output-group p span:first-child {
            font-weight: bold;
            color: #555;
            margin-right: 10px;
        }
         .output-group p span.value {
             font-weight: bold;
             text-align: right;
         }
        .overtime {
            color: green !important;
        }
        .undertime {
            color: red !important;
        }
         .info {
             font-size: 0.9rem;
             color: #777;
             text-align: center;
             margin-top: 20px;
         }
    </style>
</head>
<body>
    <div class="container">
        <h1>Arbeitszeit Rechner (Zeitzone: Berlin)</h1>

        <div class="input-group">
            <label for="startTime">Startzeit:</label>
            <input type="time" id="startTime" value="07:30">
        </div>

        <div class="input-group">
            <label for="breakMinutes">Pause (Minuten):</label>
            <div>
                <input type="number" id="breakMinutes" value="45" min="0">
                <span class="unit">Minuten</span>
            </div>
        </div>

        <div class="output-group">
            <p>
                <span>Aktuelle Uhrzeit (DE):</span>
                <span class="value" id="currentTime">--:--:--</span>
            </p>
            <p>
                <span>Gearbeitete Zeit (netto):</span>
                <span class="value" id="workedTime">--h --m</span>
            </p>
             <p>
                <span>Differenz zu 7h:</span>
                <span class="value" id="overtime">--h --m</span>
            </p>
            <p>
                <span>7h erreicht um (DE):</span>
                <span class="value" id="targetTime">--:-- Uhr</span>
            </p>
        </div>
         <p class="info">Die Berechnung wird automatisch jede Sekunde aktualisiert.</p>
    </div>

    <script>
        // Get references to DOM elements
        const startTimeInput = document.getElementById('startTime');
        const breakMinutesInput = document.getElementById('breakMinutes');
        const currentTimeDisplay = document.getElementById('currentTime');
        const workedTimeDisplay = document.getElementById('workedTime');
        const overtimeDisplay = document.getElementById('overtime');
        const targetTimeDisplay = document.getElementById('targetTime');

        // Target work duration: 7 hours in milliseconds
        const TARGET_WORK_MS = 7 * 60 * 60 * 1000;
        const NINE_AM_MINUTES = 9 * 60; // 9:00 AM in minutes from midnight
        const GERMAN_TIMEZONE = 'Europe/Berlin'; // Define the target timezone

        // Function to format milliseconds into hh:mm or +/- hh:mm
        function formatDuration(ms, showSign = false) {
            if (isNaN(ms)) return '--h --m';

            const isNegative = ms < 0;
            if (isNegative) ms = -ms;

            const totalMinutes = Math.floor(ms / (60 * 1000));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            const sign = showSign ? (isNegative ? '-' : '+') : '';
            return `${sign}${hours}h ${String(minutes).padStart(2, '0')}m`;
        }

        // --- Time Formatting Functions with Timezone ---

        // Function to format a Date object into HH:MM in the specified timezone
        function formatTime(date, timeZone) {
             if (!(date instanceof Date) || isNaN(date)) return "--:--";
             try {
                // Use Intl.DateTimeFormat for reliable timezone formatting
                return new Intl.DateTimeFormat('de-DE', {
                    timeZone: timeZone,
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false // Use 24-hour format
                }).format(date);
             } catch (e) {
                 console.error("Error formatting time:", e);
                 // Fallback or simpler formatting if Intl fails (less likely)
                 const hours = String(date.getHours()).padStart(2, '0'); // May be incorrect timezone
                 const minutes = String(date.getMinutes()).padStart(2, '0');
                 return `${hours}:${minutes} (TZ-Error)`;
             }
        }

         // Function to format a Date object into HH:MM:SS in the specified timezone
         function formatTimeWithSeconds(date, timeZone) {
             if (!(date instanceof Date) || isNaN(date)) return "--:--:--";
             try {
                 return new Intl.DateTimeFormat('de-DE', {
                    timeZone: timeZone,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false // Use 24-hour format
                }).format(date);
             } catch (e) {
                 console.error("Error formatting time with seconds:", e);
                 const hours = String(date.getHours()).padStart(2, '0'); // May be incorrect timezone
                 const minutes = String(date.getMinutes()).padStart(2, '0');
                 const seconds = String(date.getSeconds()).padStart(2, '0');
                 return `${hours}:${minutes}:${seconds} (TZ-Error)`;
             }
         }

        // Function to update default break time based on start time
        function updateDefaultBreakTime() {
            const startTimeValue = startTimeInput.value;
            if (!startTimeValue) return;

            const [startHours, startMinutes] = startTimeValue.split(':').map(Number);
            if (isNaN(startHours) || isNaN(startMinutes)) return;

            const totalStartMinutes = startHours * 60 + startMinutes;
            breakMinutesInput.value = (totalStartMinutes >= NINE_AM_MINUTES) ? 30 : 45;
        }

        // Main calculation function
        function calculateTimes() {
            // IMPORTANT: new Date() creates a date object representing the current moment.
            // Its internal value is UTC milliseconds. Calculations based on getTime() are timezone-agnostic.
            // Formatting functions will convert this moment to the desired timezone string.
            const now = new Date();

            // Display current time formatted for Germany
            currentTimeDisplay.textContent = formatTimeWithSeconds(now, GERMAN_TIMEZONE);

            // --- Get Input Values ---
            const startTimeValue = startTimeInput.value;
            const breakMinutes = parseInt(breakMinutesInput.value, 10) || 0;

            if (!startTimeValue) {
                workedTimeDisplay.textContent = '--h --m';
                overtimeDisplay.textContent = '--h --m';
                targetTimeDisplay.textContent = '--:-- Uhr';
                overtimeDisplay.className = 'value';
                return;
            }

            // --- Parse Start Time ---
            // We create the start time based on today's date and the input HH:MM.
            // Crucially, setHours/setMinutes operate in the *browser's local timezone*.
            // However, the duration calculation (now.getTime() - startTime.getTime())
            // works correctly because both `now` and `startTime` are based on the
            // same browser clock interpretation. The difference in milliseconds is universal.
            const [startHours, startMinutes] = startTimeValue.split(':').map(Number);
             if (isNaN(startHours) || isNaN(startMinutes)) {
                 console.error("Invalid start time format in calculateTimes");
                 // Clear outputs if start time is invalid during calculation
                 workedTimeDisplay.textContent = '--h --m';
                 overtimeDisplay.textContent = '--h --m';
                 targetTimeDisplay.textContent = '--:-- Uhr';
                 overtimeDisplay.className = 'value';
                 return;
             }
            const startTime = new Date(now); // Start with today's date context
            startTime.setHours(startHours, startMinutes, 0, 0); // Set HH:MM in browser's local TZ

            // --- Calculate Durations (timezone-agnostic using getTime()) ---
            let grossDurationMs = now.getTime() - startTime.getTime();
            if (grossDurationMs < 0) grossDurationMs = 0;

            const breakMs = breakMinutes * 60 * 1000;
            let netWorkedMs = grossDurationMs - breakMs;
            if (netWorkedMs < 0) netWorkedMs = 0;

            const overtimeMs = netWorkedMs - TARGET_WORK_MS;

            // --- Calculate Target Completion Time ---
            // startTime.getTime() gives UTC milliseconds for the start time (as interpreted by browser).
            // Adding durations gives the target time also in UTC milliseconds.
            const targetCompletionTimestamp = startTime.getTime() + TARGET_WORK_MS + breakMs;
            const targetCompletionTime = new Date(targetCompletionTimestamp);

            // --- Update Display ---
            // Durations are independent of timezone display
            workedTimeDisplay.textContent = formatDuration(netWorkedMs);
            overtimeDisplay.textContent = formatDuration(overtimeMs, true);

             // Style overtime/undertime
             overtimeDisplay.classList.remove('overtime', 'undertime');
             if (overtimeMs >= 0) {
                 overtimeDisplay.classList.add('overtime');
             } else {
                 overtimeDisplay.classList.add('undertime');
             }

            // Format the target completion time for the German timezone
            targetTimeDisplay.textContent = `${formatTime(targetCompletionTime, GERMAN_TIMEZONE)} Uhr`;
        }

        // --- Event Listeners ---
        startTimeInput.addEventListener('input', () => {
            updateDefaultBreakTime();
            calculateTimes();
        });
        breakMinutesInput.addEventListener('input', calculateTimes);

        const intervalID = setInterval(calculateTimes, 1000);

        document.addEventListener('DOMContentLoaded', () => {
             updateDefaultBreakTime();
             calculateTimes();
        });

    </script>
</body>
</html>